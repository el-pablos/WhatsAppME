/**
 * Order Handler - Menangani pemesanan produk dengan WhatsApp Business style
 */

const ProductManager = require('../utils/productManager');
const UserManager = require('../utils/userManager');

class OrderHandler {
  constructor() {
    this.productManager = new ProductManager();
    this.userManager = new UserManager();
    this.orderSessions = new Map(); // Store order sessions
  }

  /**
   * Handle order commands
   */
  async handleOrderCommand(message, command) {
    const userId = message.from;
    const args = command.split(' ').slice(1);

    try {
      if (args.length > 0 && args[0].startsWith('prod_')) {
        // Order specific product
        await this.startOrderProcess(message, args[0]);
      } else if (command.includes('cara order')) {
        await this.showOrderGuide(message);
      } else {
        await this.showOrderHelp(message);
      }
    } catch (error) {
      console.error('‚ùå Error in order handler:', error);
      await message.reply('‚ùå Maaf, terjadi kesalahan saat memproses pesanan.');
    }
  }

  /**
   * Start order process for specific product
   */
  async startOrderProcess(message, productId) {
    const product = this.productManager.getProductById(productId);
    const userId = message.from;
    
    if (!product) {
      await message.reply('‚ùå Produk tidak ditemukan. Ketik *produk* untuk melihat katalog.');
      return;
    }

    // Check stock availability
    const totalStock = product.variants && product.variants.length > 0
      ? product.variants.reduce((sum, v) => sum + (v.stock || 0), 0)
      : 1;

    if (totalStock === 0) {
      await message.reply(`‚ùå Maaf, produk "${product.name}" sedang habis stok.\n\n` +
                         `üîî Ketik *notify ${productId}* untuk notifikasi saat stok tersedia\n` +
                         `üîô Lihat produk lain: ketik *produk*`);
      return;
    }

    // Create order session
    this.orderSessions.set(userId, {
      productId: productId,
      product: product,
      step: 'variant_selection',
      startTime: Date.now()
    });

    // Show order form
    await this.showOrderForm(message, product);
  }

  /**
   * Show order form dengan WhatsApp Business style
   */
  async showOrderForm(message, product) {
    const priceFormatted = this.productManager.formatPrice(product.price);
    
    let orderText = `üõí *FORM PEMESANAN*\n\n`;
    orderText += `‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
    orderText += `‚îÇ     üì¶ *ORDER PRODUK*    ‚îÇ\n`;
    orderText += `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n`;

    // Product info
    orderText += `üõçÔ∏è *Produk:* ${product.name}\n`;
    orderText += `üí∞ *Harga:* ${priceFormatted}\n\n`;

    // Variants selection
    if (product.variants && product.variants.length > 0) {
      orderText += `üé® *Pilih Varian:*\n\n`;
      
      product.variants.forEach((variant, index) => {
        const variantPrice = this.productManager.formatPrice(variant.price);
        const stockStatus = variant.stock > 0 ? `‚úÖ ${variant.stock} unit` : '‚ùå Habis';
        const isAvailable = variant.stock > 0;
        
        orderText += `${index + 1}Ô∏è‚É£ ${variant.name}\n`;
        orderText += `   üí∞ ${variantPrice}\n`;
        orderText += `   üì¶ ${stockStatus}\n`;
        
        if (isAvailable) {
          orderText += `   ‚úÖ *Pilih: ketik ${index + 1}*\n\n`;
        } else {
          orderText += `   ‚ùå *Tidak tersedia*\n\n`;
        }
      });
    } else {
      // No variants, direct order
      orderText += `üì¶ *Stok tersedia*\n\n`;
      orderText += `‚úÖ *Lanjut order: ketik "lanjut"*\n\n`;
    }

    orderText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    orderText += `üìã *Informasi Pemesanan:*\n`;
    orderText += `‚Ä¢ Pilih varian yang diinginkan\n`;
    orderText += `‚Ä¢ Isi data pengiriman\n`;
    orderText += `‚Ä¢ Konfirmasi pesanan\n`;
    orderText += `‚Ä¢ Lakukan pembayaran\n\n`;

    orderText += `‚ùå *Batal order:* ketik *batal*\n`;
    orderText += `üîô *Kembali ke produk:* ketik *produk ${product.id}*`;

    await message.reply(orderText);
  }

  /**
   * Process order step
   */
  async processOrderStep(message, userInput) {
    const userId = message.from;
    const session = this.orderSessions.get(userId);

    if (!session) {
      await message.reply('‚ùå Tidak ada sesi order aktif. Ketik *produk* untuk mulai berbelanja.');
      return;
    }

    // Check session timeout (30 minutes)
    if (Date.now() - session.startTime > 30 * 60 * 1000) {
      this.orderSessions.delete(userId);
      await message.reply('‚è∞ Sesi order telah berakhir. Silakan mulai order baru.');
      return;
    }

    switch (session.step) {
      case 'variant_selection':
        await this.handleVariantSelection(message, session, userInput);
        break;
      case 'quantity_input':
        await this.handleQuantityInput(message, session, userInput);
        break;
      case 'customer_info':
        await this.handleCustomerInfo(message, session, userInput);
        break;
      case 'confirmation':
        await this.handleOrderConfirmation(message, session, userInput);
        break;
    }
  }

  /**
   * Handle variant selection
   */
  async handleVariantSelection(message, session, userInput) {
    const product = session.product;
    const variantIndex = parseInt(userInput) - 1;

    if (userInput.toLowerCase() === 'lanjut' && (!product.variants || product.variants.length === 0)) {
      // No variants, proceed to quantity
      session.selectedVariant = null;
      session.step = 'quantity_input';
      await this.askQuantity(message, session);
      return;
    }

    if (isNaN(variantIndex) || variantIndex < 0 || variantIndex >= product.variants.length) {
      await message.reply('‚ùå Pilihan tidak valid. Silakan pilih nomor varian yang tersedia.');
      return;
    }

    const selectedVariant = product.variants[variantIndex];
    
    if (selectedVariant.stock <= 0) {
      await message.reply('‚ùå Varian ini sedang habis stok. Silakan pilih varian lain.');
      return;
    }

    session.selectedVariant = selectedVariant;
    session.step = 'quantity_input';
    
    await this.askQuantity(message, session);
  }

  /**
   * Ask for quantity
   */
  async askQuantity(message, session) {
    const product = session.product;
    const variant = session.selectedVariant;
    const maxStock = variant ? variant.stock : 10;

    let quantityText = `üìä *PILIH JUMLAH*\n\n`;
    quantityText += `üõçÔ∏è *Produk:* ${product.name}\n`;
    
    if (variant) {
      quantityText += `üé® *Varian:* ${variant.name}\n`;
      quantityText += `üí∞ *Harga:* ${this.productManager.formatPrice(variant.price)}\n`;
    } else {
      quantityText += `üí∞ *Harga:* ${this.productManager.formatPrice(product.price)}\n`;
    }
    
    quantityText += `üì¶ *Stok tersedia:* ${maxStock} unit\n\n`;
    quantityText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    quantityText += `üî¢ *Masukkan jumlah yang diinginkan:*\n`;
    quantityText += `‚Ä¢ Minimal: 1 unit\n`;
    quantityText += `‚Ä¢ Maksimal: ${Math.min(maxStock, 10)} unit\n\n`;
    quantityText += `üí° *Contoh:* ketik *2* untuk 2 unit\n\n`;
    quantityText += `‚ùå *Batal:* ketik *batal*`;

    await message.reply(quantityText);
  }

  /**
   * Handle quantity input
   */
  async handleQuantityInput(message, session, userInput) {
    const quantity = parseInt(userInput);
    const variant = session.selectedVariant;
    const maxStock = variant ? variant.stock : 10;

    if (isNaN(quantity) || quantity < 1) {
      await message.reply('‚ùå Jumlah tidak valid. Masukkan angka minimal 1.');
      return;
    }

    if (quantity > maxStock) {
      await message.reply(`‚ùå Jumlah melebihi stok tersedia (${maxStock} unit). Silakan kurangi jumlah.`);
      return;
    }

    if (quantity > 10) {
      await message.reply('‚ùå Maksimal pembelian 10 unit per transaksi. Untuk pembelian dalam jumlah besar, hubungi admin.');
      return;
    }

    session.quantity = quantity;
    session.step = 'customer_info';
    
    await this.askCustomerInfo(message, session);
  }

  /**
   * Ask for customer information
   */
  async askCustomerInfo(message, session) {
    const product = session.product;
    const variant = session.selectedVariant;
    const quantity = session.quantity;
    
    const unitPrice = variant ? variant.price : product.price;
    const totalPrice = unitPrice * quantity;
    const totalFormatted = this.productManager.formatPrice(totalPrice);

    let infoText = `üìù *DATA PENGIRIMAN*\n\n`;
    infoText += `üìã *Ringkasan Pesanan:*\n`;
    infoText += `üõçÔ∏è ${product.name}\n`;
    
    if (variant) {
      infoText += `üé® Varian: ${variant.name}\n`;
    }
    
    infoText += `üî¢ Jumlah: ${quantity} unit\n`;
    infoText += `üí∞ Total: ${totalFormatted}\n\n`;
    infoText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    infoText += `üìÆ *Masukkan data pengiriman:*\n\n`;
    infoText += `*Format:*\n`;
    infoText += `Nama: [Nama lengkap]\n`;
    infoText += `HP: [Nomor WhatsApp]\n`;
    infoText += `Alamat: [Alamat lengkap]\n`;
    infoText += `Kota: [Kota]\n`;
    infoText += `Kodepos: [Kode pos]\n\n`;
    infoText += `üìù *Contoh:*\n`;
    infoText += `Nama: John Doe\n`;
    infoText += `HP: 081234567890\n`;
    infoText += `Alamat: Jl. Merdeka No. 123\n`;
    infoText += `Kota: Jakarta Selatan\n`;
    infoText += `Kodepos: 12345\n\n`;
    infoText += `‚ùå *Batal:* ketik *batal*`;

    await message.reply(infoText);
  }

  /**
   * Handle customer info input
   */
  async handleCustomerInfo(message, session, userInput) {
    // Parse customer info
    const lines = userInput.split('\n');
    const customerInfo = {};

    lines.forEach(line => {
      const [key, ...valueParts] = line.split(':');
      if (key && valueParts.length > 0) {
        const cleanKey = key.trim().toLowerCase();
        const value = valueParts.join(':').trim();
        customerInfo[cleanKey] = value;
      }
    });

    // Validate required fields
    const requiredFields = ['nama', 'hp', 'alamat', 'kota'];
    const missingFields = requiredFields.filter(field => !customerInfo[field]);

    if (missingFields.length > 0) {
      await message.reply(`‚ùå Data tidak lengkap. Harap isi:\n‚Ä¢ ${missingFields.join('\n‚Ä¢ ')}\n\nSilakan kirim ulang data lengkap.`);
      return;
    }

    session.customerInfo = customerInfo;
    session.step = 'confirmation';
    
    await this.showOrderConfirmation(message, session);
  }

  /**
   * Show order confirmation
   */
  async showOrderConfirmation(message, session) {
    const product = session.product;
    const variant = session.selectedVariant;
    const quantity = session.quantity;
    const customerInfo = session.customerInfo;
    
    const unitPrice = variant ? variant.price : product.price;
    const subtotal = unitPrice * quantity;
    const shippingCost = 15000; // Fixed shipping cost
    const total = subtotal + shippingCost;

    let confirmText = `‚úÖ *KONFIRMASI PESANAN*\n\n`;
    confirmText += `‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
    confirmText += `‚îÇ    üìã *DETAIL PESANAN*   ‚îÇ\n`;
    confirmText += `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n`;

    // Product details
    confirmText += `üõçÔ∏è *Produk:* ${product.name}\n`;
    if (variant) {
      confirmText += `üé® *Varian:* ${variant.name}\n`;
    }
    confirmText += `üî¢ *Jumlah:* ${quantity} unit\n`;
    confirmText += `üí∞ *Harga satuan:* ${this.productManager.formatPrice(unitPrice)}\n\n`;

    // Customer info
    confirmText += `üìÆ *Data Pengiriman:*\n`;
    confirmText += `üë§ ${customerInfo.nama}\n`;
    confirmText += `üì± ${customerInfo.hp}\n`;
    confirmText += `üìç ${customerInfo.alamat}\n`;
    confirmText += `üèôÔ∏è ${customerInfo.kota}`;
    if (customerInfo.kodepos) {
      confirmText += ` ${customerInfo.kodepos}`;
    }
    confirmText += `\n\n`;

    // Price breakdown
    confirmText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    confirmText += `üí∞ *Rincian Biaya:*\n`;
    confirmText += `‚Ä¢ Subtotal: ${this.productManager.formatPrice(subtotal)}\n`;
    confirmText += `‚Ä¢ Ongkir: ${this.productManager.formatPrice(shippingCost)}\n`;
    confirmText += `‚Ä¢ *Total: ${this.productManager.formatPrice(total)}*\n\n`;

    confirmText += `‚úÖ *Konfirmasi:* ketik *ya* atau *konfirm*\n`;
    confirmText += `‚úèÔ∏è *Edit data:* ketik *edit*\n`;
    confirmText += `‚ùå *Batal:* ketik *batal*`;

    await message.reply(confirmText);
  }

  /**
   * Handle order confirmation
   */
  async handleOrderConfirmation(message, session, userInput) {
    const input = userInput.toLowerCase();

    if (input === 'ya' || input === 'konfirm' || input === 'confirm') {
      await this.finalizeOrder(message, session);
    } else if (input === 'edit') {
      session.step = 'customer_info';
      await this.askCustomerInfo(message, session);
    } else {
      await message.reply('‚ùå Pilihan tidak valid. Ketik *ya* untuk konfirmasi, *edit* untuk ubah data, atau *batal* untuk membatalkan.');
    }
  }

  /**
   * Finalize order
   */
  async finalizeOrder(message, session) {
    const userId = message.from;
    const orderId = `ORD${Date.now()}`;
    
    // Save order (in real implementation, save to database)
    const orderData = {
      orderId: orderId,
      userId: userId,
      product: session.product,
      variant: session.selectedVariant,
      quantity: session.quantity,
      customerInfo: session.customerInfo,
      status: 'pending_payment',
      createdAt: new Date().toISOString()
    };

    // Clear session
    this.orderSessions.delete(userId);

    // Send order success message
    let successText = `üéâ *PESANAN BERHASIL DIBUAT!*\n\n`;
    successText += `üìã *Order ID:* ${orderId}\n`;
    successText += `‚è∞ *Waktu:* ${new Date().toLocaleString('id-ID')}\n\n`;
    successText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    successText += `üí≥ *LANGKAH SELANJUTNYA:*\n\n`;
    successText += `1Ô∏è‚É£ *Lakukan Pembayaran*\n`;
    successText += `   Ketik *payment* untuk info pembayaran\n\n`;
    successText += `2Ô∏è‚É£ *Kirim Bukti Transfer*\n`;
    successText += `   Sertakan Order ID: ${orderId}\n\n`;
    successText += `3Ô∏è‚É£ *Tunggu Konfirmasi*\n`;
    successText += `   Admin akan konfirmasi dalam 1x24 jam\n\n`;
    successText += `üìû *Hubungi Admin:* ketik *kontak*\n`;
    successText += `üí≥ *Info Pembayaran:* ketik *payment*\n\n`;
    successText += `üôè Terima kasih telah berbelanja di TAM Store!`;

    await message.reply(successText);

    // Send payment info after delay
    setTimeout(async () => {
      const PaymentHandler = require('./paymentHandler');
      const paymentHandler = new PaymentHandler();
      await paymentHandler.handlePaymentRequest(message);
    }, 3000);
  }

  /**
   * Cancel order
   */
  async cancelOrder(message) {
    const userId = message.from;
    
    if (this.orderSessions.has(userId)) {
      this.orderSessions.delete(userId);
      await message.reply('‚ùå Pesanan dibatalkan.\n\nüõçÔ∏è Mulai belanja lagi: ketik *produk*');
    } else {
      await message.reply('‚ùå Tidak ada pesanan aktif untuk dibatalkan.');
    }
  }

  /**
   * Show order guide
   */
  async showOrderGuide(message) {
    let guideText = `üìñ *PANDUAN PEMESANAN*\n\n`;
    guideText += `‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
    guideText += `‚îÇ    üõí *CARA ORDER*       ‚îÇ\n`;
    guideText += `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\n\n`;

    guideText += `üìã *Langkah-langkah:*\n\n`;
    guideText += `1Ô∏è‚É£ *Pilih Produk*\n`;
    guideText += `   ‚Ä¢ Ketik *produk* untuk lihat katalog\n`;
    guideText += `   ‚Ä¢ Pilih produk yang diinginkan\n\n`;

    guideText += `2Ô∏è‚É£ *Mulai Order*\n`;
    guideText += `   ‚Ä¢ Ketik *order [ID produk]*\n`;
    guideText += `   ‚Ä¢ Contoh: *order prod_001*\n\n`;

    guideText += `3Ô∏è‚É£ *Pilih Varian & Jumlah*\n`;
    guideText += `   ‚Ä¢ Pilih varian yang tersedia\n`;
    guideText += `   ‚Ä¢ Tentukan jumlah pembelian\n\n`;

    guideText += `4Ô∏è‚É£ *Isi Data Pengiriman*\n`;
    guideText += `   ‚Ä¢ Nama, HP, alamat lengkap\n`;
    guideText += `   ‚Ä¢ Pastikan data benar\n\n`;

    guideText += `5Ô∏è‚É£ *Konfirmasi & Bayar*\n`;
    guideText += `   ‚Ä¢ Cek detail pesanan\n`;
    guideText += `   ‚Ä¢ Lakukan pembayaran\n`;
    guideText += `   ‚Ä¢ Kirim bukti transfer\n\n`;

    guideText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
    guideText += `üí° *Tips:*\n`;
    guideText += `‚Ä¢ Siapkan data lengkap sebelum order\n`;
    guideText += `‚Ä¢ Cek stok sebelum memesan\n`;
    guideText += `‚Ä¢ Simpan Order ID untuk referensi\n\n`;

    guideText += `üõçÔ∏è *Mulai belanja:* ketik *produk*`;

    await message.reply(guideText);
  }

  /**
   * Show order help
   */
  async showOrderHelp(message) {
    let helpText = `üÜò *BANTUAN ORDER*\n\n`;
    helpText += `üõí *Perintah Order:*\n`;
    helpText += `‚Ä¢ *order [ID]* - Pesan produk\n`;
    helpText += `‚Ä¢ *cara order* - Panduan lengkap\n`;
    helpText += `‚Ä¢ *batal* - Batalkan pesanan\n\n`;
    helpText += `üìû *Butuh bantuan?*\n`;
    helpText += `Ketik *kontak* untuk hubungi admin`;

    await message.reply(helpText);
  }

  /**
   * Check if user has active order session
   */
  hasActiveSession(userId) {
    return this.orderSessions.has(userId);
  }

  /**
   * Get user's active session
   */
  getActiveSession(userId) {
    return this.orderSessions.get(userId);
  }
}

module.exports = OrderHandler;
